<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Compras & Cotações</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body { font-family: 'Inter', sans-serif; }

        /* Animação suave */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* Scrollbar personalizada */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Apenas esconde elementos com a classe no-print durante impressão normal do navegador, 
           caso alguém tente imprimir a tela principal */
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans selection:bg-blue-100 selection:text-blue-900 overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback, useRef } = React;

        // --- Ícones Modernos ---
        const Icons = {
            Menu: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Save: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            ArrowLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            ShoppingCart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>,
            Trophy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Store: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></svg>,
            Package: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></svg>,
            Calculator: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            FileText: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            LayoutDashboard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            Printer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Pencil: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            TrendingUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            Lightbulb: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
            Split: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"/><path d="m15 9 6-6"/></svg>,
            CloudCheck: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="m8 15 3 3 6-6"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            AlertTriangle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Lock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        };

        // --- Função para Gerar Janela de Impressão (Layout Moderno) ---
        const openPrintWindow = (quote, calculations, summaryStats) => {
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Pop-up bloqueado. Por favor, permita pop-ups para imprimir.');
                return;
            }

            const { totalsPerSupplier, winnerId, bestMixTotal } = calculations;
            
            // Lógica de Ordenação das Colunas (Vencedor primeiro, depois ordem crescente, sem preço por último)
            const sortedSuppliers = quote.suppliers.map(s => ({
                id: s.id, 
                name: s.name, 
                total: totalsPerSupplier[s.id] || 0
            })).sort((a, b) => {
                if (a.total > 0 && b.total === 0) return -1; // Com preço vem antes
                if (a.total === 0 && b.total > 0) return 1;  // Sem preço vai pro fim
                if (a.total === 0 && b.total === 0) return 0; // Ambos sem preço
                return a.total - b.total; // Menor preço vence
            });

            const winner = sortedSuppliers.find(s => s.total > 0);

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Relatório de Cotação - ${quote.title}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
                        body { font-family: 'Inter', sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        @media print {
                            @page { margin: 10mm; size: A4; }
                            .no-print { display: none !important; }
                            /* Força background na impressão */
                            .print-bg-force { box-shadow: inset 0 0 0 1000px #cbd5e1 !important; } /* slate-300 */
                            .print-bg-header { box-shadow: inset 0 0 0 1000px #f1f5f9 !important; } /* slate-100 */
                        }
                    </style>
                </head>
                <body class="bg-white text-slate-900 p-8 max-w-[210mm] mx-auto">
                    
                    <!-- Cabeçalho -->
                    <div class="border-b-2 border-slate-800 pb-6 mb-8 flex justify-between items-end">
                        <div>
                            <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Relatório Técnico de Compras</h2>
                            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight leading-tight uppercase">${quote.title || "Sem Título"}</h1>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold text-slate-800">Cotação #${quote.id}</div>
                            <div class="text-xs text-slate-500">${new Date().toLocaleDateString('pt-BR')}</div>
                        </div>
                    </div>

                    <!-- Ranking Top 3 (Agora baseado na ordem correta) -->
                    <div class="mb-10">
                        <h3 class="text-sm font-bold text-slate-900 border-l-4 border-slate-800 pl-3 mb-4 uppercase tracking-wide">
                            Ranking de Fornecedores (Top 3)
                        </h3>
                        <div class="overflow-hidden border border-slate-300 rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-100 border-b border-slate-300 text-slate-600 font-bold uppercase text-xs print-bg-header">
                                    <tr>
                                        <th class="py-3 px-4 text-left w-16">Pos.</th>
                                        <th class="py-3 px-4 text-left">Fornecedor</th>
                                        <th class="py-3 px-4 text-right">Total</th>
                                        <th class="py-3 px-4 text-right">Diferença</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200">
                                    ${sortedSuppliers.filter(s => s.total > 0).slice(0, 3).map((s, idx) => {
                                        const diff = winner ? s.total - winner.total : 0;
                                        const isWinner = idx === 0;
                                        return `
                                            <tr class="${isWinner ? 'bg-slate-50 font-bold' : ''}">
                                                <td class="py-3 px-4">
                                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full ${isWinner ? 'bg-slate-800 text-white' : 'bg-slate-200 text-slate-600'} text-xs">
                                                        ${idx + 1}º
                                                    </span>
                                                </td>
                                                <td class="py-3 px-4 text-slate-800">${s.name} ${isWinner ? '(Vencedor)' : ''}</td>
                                                <td class="py-3 px-4 text-right">R$ ${s.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                                <td class="py-3 px-4 text-right text-slate-500">
                                                    ${idx === 0 ? '-' : `+ R$ ${diff.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                     ${sortedSuppliers.filter(s => s.total > 0).length === 0 ? '<tr><td colspan="4" class="p-4 text-center text-slate-500">Nenhum fornecedor cotado.</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    ${summaryStats.mixSavings > 0 ? `
                        <div class="mb-10 border border-slate-300 border-dashed rounded-lg p-4 break-inside-avoid">
                            <h3 class="text-slate-800 font-bold text-xs uppercase tracking-wider mb-2">Análise de Economia Fracionada</h3>
                            <p class="text-slate-700 text-sm leading-relaxed">
                                A compra fracionada (item a item no menor preço) resultaria em um total de <strong>R$ ${bestMixTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>.
                                <br>Economia potencial de <strong>R$ ${summaryStats.mixSavings.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong> em relação ao 1º colocado.
                            </p>
                        </div>
                    ` : ''}

                    <!-- Tabela de Itens Detalhada (Colunas Reordenadas) -->
                    <div class="mb-10">
                        <h3 class="text-sm font-bold text-slate-900 border-l-4 border-slate-800 pl-3 mb-4 uppercase tracking-wide">
                            Comparativo Item a Item
                        </h3>
                        <table class="w-full text-xs border-collapse border border-slate-300">
                            <thead>
                                <tr class="bg-slate-100 text-slate-700 uppercase tracking-wider text-left border-b border-slate-300 print-bg-header">
                                    <th class="py-2 px-2 border-r border-slate-300 font-bold w-1/3">Item</th>
                                    <th class="py-2 px-2 border-r border-slate-300 text-center font-bold w-16">Qtd.</th>
                                    ${sortedSuppliers.map(s => `
                                        <th class="py-2 px-2 border-r border-slate-300 text-right font-bold ${s.id === winnerId ? 'bg-slate-200 print-bg-force' : ''}">${s.name}</th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody class="text-slate-800">
                                ${quote.items.map((item, idx) => {
                                    const rowPrices = sortedSuppliers.map(s => parseFloat(quote.prices[`${item.id}_${s.id}`]) || 0).filter(p => p > 0);
                                    const minRowPrice = rowPrices.length > 0 ? Math.min(...rowPrices) : null;
                                    
                                    return `
                                    <tr class="border-b border-slate-200 ${idx % 2 !== 0 ? 'bg-slate-50' : ''}">
                                        <td class="py-2 px-2 border-r border-slate-200 font-medium">${item.name}</td>
                                        <td class="py-2 px-2 border-r border-slate-200 text-center">${item.qty} ${item.unit}</td>
                                        ${sortedSuppliers.map(s => {
                                            const price = parseFloat(quote.prices[`${item.id}_${s.id}`]) || 0;
                                            const isBest = minRowPrice !== null && price === minRowPrice;
                                            const isWinnerCol = s.id === winnerId;
                                            const key = `${item.id}_${s.id}`;
                                            const qty = quote.quantities?.[key] !== undefined ? parseFloat(quote.quantities[key]) : item.qty;
                                            const qtyDiff = qty !== item.qty;

                                            // Estilo para destacar o menor preço (Otimizado para P&B)
                                            let cellStyle = "text-right px-2 border-r border-slate-200 ";
                                            if (isBest) {
                                                cellStyle += "bg-slate-300 font-extrabold border border-slate-400 print-bg-force"; 
                                            } else if (isWinnerCol) {
                                                cellStyle += "bg-slate-100";
                                            }

                                            return `
                                                <td class="${cellStyle} py-2">
                                                    <div>${price ? `R$ ${price.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : '-'}</div>
                                                    ${qtyDiff ? `<div class="text-[9px] font-bold">(${qty} ${item.unit})</div>` : ''}
                                                </td>
                                            `;
                                        }).join('')}
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            <tfoot class="font-bold text-slate-900 bg-slate-100 border-t-2 border-slate-800 print-bg-header">
                                <tr>
                                    <td colspan="2" class="py-3 px-2 text-right border-r border-slate-300 uppercase tracking-wider">Total:</td>
                                    ${sortedSuppliers.map(s => `
                                        <td class="py-3 px-2 text-right border-r border-slate-300 ${s.id === winnerId ? 'bg-slate-300 print-bg-force' : ''}">
                                            R$ ${s.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                        </td>
                                    `).join('')}
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    ${quote.observation ? `
                        <div class="mb-8 p-4 bg-slate-50 border-l-4 border-blue-500 rounded-r-lg print-bg-header">
                            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Observações</h3>
                            <p class="text-sm text-slate-700">${quote.observation}</p>
                        </div>
                    ` : ''}

                    <!-- Rodapé Simples -->
                    <div class="fixed bottom-0 left-0 w-full text-center py-4 bg-white border-t border-slate-200">
                        <p class="text-[10px] text-slate-500 uppercase">Sistema de Compras v1.0 &bull; Relatório Gerado Automaticamente</p>
                    </div>

                    <script>
                        setTimeout(() => { window.print(); }, 500);
                    <\/script>
                </body>
                </html>
            `;

            printWindow.document.write(htmlContent);
            printWindow.document.close();
        };

        // --- Tela de Login ---
        function LoginScreen({ onLogin }) {
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                if(pass === '285') {
                    onLogin();
                } else {
                    setErr('Senha incorreta. Tente novamente.');
                    setPass('');
                }
            }

            return (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center">
                        <div className="bg-blue-600 text-white p-4 rounded-2xl inline-flex mb-6 shadow-lg shadow-blue-200">
                            <Icons.Lock className="h-10 w-10" />
                        </div>
                        <h1 className="text-2xl font-bold text-slate-800 mb-2">Acesso Restrito</h1>
                        <p className="text-slate-400 text-sm mb-8">Digite sua credencial para continuar</p>
                        
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div className="relative">
                                <input 
                                    type="password" 
                                    value={pass}
                                    onChange={e => {setPass(e.target.value); setErr('')}}
                                    className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3.5 text-center text-lg font-bold tracking-widest focus:ring-2 focus:ring-blue-500 outline-none transition"
                                    placeholder="••••"
                                    maxLength={10}
                                    autoFocus
                                />
                            </div>
                            {err && <div className="text-red-500 text-xs font-bold animate-pulse">{err}</div>}
                            <button type="submit" className="w-full bg-slate-900 hover:bg-slate-800 text-white py-3.5 rounded-xl font-bold transition flex items-center justify-center">
                                Entrar no Sistema <Icons.ChevronRight className="ml-2 h-4 w-4" />
                            </button>
                        </form>
                    </div>
                </div>
            )
        }

        // --- Componente Sidebar ---
        function Sidebar({ view, setView, isExpanded, toggle }) {
            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: Icons.LayoutDashboard },
                { id: 'list', label: 'Minhas Cotações', icon: Icons.FileText },
                { id: 'settings', label: 'Configurações', icon: Icons.Settings },
            ];

            return (
                <aside className={`bg-white border-r border-slate-200 h-screen sticky top-0 transition-all duration-300 flex flex-col z-40 no-print ${isExpanded ? 'w-64' : 'w-20'}`}>
                    <div className="p-4 flex items-center justify-between h-20 border-b border-slate-100">
                        <div className={`flex items-center gap-3 overflow-hidden transition-all duration-300 ${isExpanded ? 'opacity-100' : 'opacity-0 w-0'}`}>
                            <div className="bg-blue-600 text-white p-1.5 rounded-lg shrink-0">
                                <Icons.Calculator className="h-6 w-6" />
                            </div>
                            <div className="whitespace-nowrap">
                                <h1 className="font-bold text-slate-800 text-sm">Sistema de</h1>
                                <h1 className="font-bold text-slate-800 text-sm">Compras</h1>
                            </div>
                        </div>
                        <button onClick={toggle} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition mx-auto" title={isExpanded ? "Recolher Menu" : "Expandir Menu"}>
                            <Icons.Menu className="h-6 w-6" />
                        </button>
                    </div>

                    <nav className="flex-1 p-3 space-y-2 mt-4">
                        {menuItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => setView(item.id)}
                                className={`w-full flex items-center p-3 rounded-xl transition-all duration-200 group relative ${view === item.id ? 'bg-blue-50 text-blue-600' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}`}
                            >
                                <item.icon className={`h-6 w-6 shrink-0 transition-colors ${view === item.id ? 'text-blue-600' : 'text-slate-400 group-hover:text-slate-600'} ${isExpanded ? 'mr-3' : 'mx-auto'}`} />
                                
                                <span className={`whitespace-nowrap transition-all duration-300 origin-left ${isExpanded ? 'opacity-100 w-auto' : 'opacity-0 w-0 hidden'}`}>
                                    {item.label}
                                </span>

                                {!isExpanded && (
                                    <div className="absolute left-full ml-3 px-3 py-2 bg-slate-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-50 transition-opacity shadow-xl">
                                        {item.label}
                                        <div className="absolute top-1/2 -left-1 -translate-y-1/2 border-4 border-transparent border-r-slate-800"></div>
                                    </div>
                                )}
                            </button>
                        ))}
                    </nav>

                    <div className={`p-4 border-t border-slate-100 text-xs text-slate-400 text-center ${isExpanded ? 'block' : 'hidden'}`}>
                        v1.0.4
                    </div>
                </aside>
            );
        }

        // --- Componente Principal ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            
            // Inicializa do LocalStorage ou vazio
            const [quotations, setQuotations] = useState(() => {
                const saved = localStorage.getItem('sys_quotations');
                return saved ? JSON.parse(saved) : [];
            });
            const [activeQuote, setActiveQuote] = useState(null);

            // Efeito para salvar no LocalStorage sempre que 'quotations' mudar
            useEffect(() => {
                localStorage.setItem('sys_quotations', JSON.stringify(quotations));
            }, [quotations]);

            // Efeito para "Auto-Save" e cálculos em tempo real
            useEffect(() => {
                if (activeQuote) {
                    const totalsPerSupplier = {};
                    let minTotal = Infinity;
                    let winner = 'N/A';
                    
                    activeQuote.suppliers.forEach(s => {
                        let sum = 0;
                        activeQuote.items.forEach(i => {
                            const key = `${i.id}_${s.id}`;
                            const qty = activeQuote.quantities?.[key] !== undefined ? parseFloat(activeQuote.quantities[key]) : i.qty;
                            sum += (parseFloat(activeQuote.prices[key]) || 0) * qty;
                        });
                        totalsPerSupplier[s.id] = sum;
                        if (sum > 0 && sum < minTotal) {
                            minTotal = sum;
                            winner = s.name;
                        }
                    });

                    // Atualiza o objeto da cotação com os novos totais
                    const updatedQuote = {
                        ...activeQuote,
                        total: minTotal === Infinity ? 0 : minTotal,
                        winner: winner,
                        status: activeQuote.suppliers.length > 0 && activeQuote.items.length > 0 ? 'Finalizada' : 'Rascunho'
                    };

                    // Atualiza a lista principal sem re-renderizar o editor inteiro (otimização básica)
                    setQuotations(prev => {
                        const index = prev.findIndex(q => q.id === activeQuote.id);
                        if (index !== -1) {
                            // Só atualiza se houver mudança real para evitar loops infinitos se usasse dependências erradas
                            if (JSON.stringify(prev[index]) !== JSON.stringify(updatedQuote)) {
                                const newQuotations = [...prev];
                                newQuotations[index] = updatedQuote;
                                return newQuotations;
                            }
                        }
                        return prev;
                    });
                }
            }, [activeQuote]);

            const handleNewQuotation = () => {
                const newQuote = {
                    id: Date.now(),
                    title: 'Nova Cotação',
                    date: new Date().toISOString().split('T')[0],
                    status: 'Em Aberto',
                    items: [],
                    suppliers: [],
                    prices: {},
                    quantities: {},
                    observation: '' // New field
                };
                // Adiciona imediatamente à lista e salva (devido ao useEffect)
                setQuotations(prev => [newQuote, ...prev]);
                setActiveQuote(newQuote);
                setView('edit');
            };

            const handleOpenQuotation = (quote) => {
                setActiveQuote(quote);
                setView('edit');
            };

            const handleDeleteQuotation = (id) => {
                setQuotations(prev => prev.filter(q => q.id !== id));
            };

            // Apenas fecha o editor, pois o salvamento é automático
            const handleCloseEditor = () => {
                setActiveQuote(null);
                setView('list');
            };

            // SE NÃO ESTIVER AUTENTICADO, MOSTRA LOGIN
            if (!isAuthenticated) {
                return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;
            }

            return (
                <div className="flex min-h-screen bg-slate-50 text-slate-800 font-sans">
                    <Sidebar 
                        view={view} 
                        setView={setView} 
                        isExpanded={isSidebarOpen} 
                        toggle={() => setIsSidebarOpen(prev => !prev)} 
                    />

                    <div className="flex-1 h-screen overflow-y-auto bg-slate-50/50">
                        <main className="max-w-7xl mx-auto px-6 py-8 pb-20">
                            {view === 'dashboard' && (
                                <Dashboard 
                                    quotations={quotations} 
                                    onNew={handleNewQuotation}
                                    onOpen={handleOpenQuotation} 
                                />
                            )}
                            
                            {view === 'list' && (
                                <QuotationList 
                                    quotations={quotations} 
                                    onNew={handleNewQuotation}
                                    onOpen={handleOpenQuotation}
                                    onDelete={handleDeleteQuotation}
                                />
                            )}
                            
                            {view === 'edit' && activeQuote && (
                                <QuotationEditor 
                                    quote={activeQuote} 
                                    setQuote={setActiveQuote}
                                    onBack={handleCloseEditor}
                                />
                            )}

                            {view === 'settings' && (
                                <Settings 
                                    quotations={quotations} 
                                    setQuotations={setQuotations} 
                                />
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        // --- Dashboard Avançado (Modernizado) ---
        function Dashboard({ quotations, onNew, onOpen }) {
            const stats = useMemo(() => {
                const totalSpent = quotations.reduce((acc, q) => acc + (q.total || 0), 0);
                const totalQuotes = quotations.length;
                const completedQuotes = quotations.filter(q => q.status === 'Finalizada').length;
                const winners = quotations.map(q => q.winner).filter(w => w && w !== 'N/A');
                const winnerCounts = winners.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                const topWinner = Object.keys(winnerCounts).sort((a,b) => winnerCounts[b] - winnerCounts[a])[0] || '-';
                return { totalSpent, totalQuotes, completedQuotes, topWinner };
            }, [quotations]);

            // Pegar as 4 últimas cotações para a lista rápida
            const recentQuotes = useMemo(() => {
                return [...quotations].sort((a, b) => b.id - a.id).slice(0, 4);
            }, [quotations]);
            
            // Dicas rotativas
            const tips = [
                {
                    title: "Dica Pro",
                    text: "Adicione ao menos 3 fornecedores por cotação. O sistema irá automaticamente destacar as melhores oportunidades e sugerir compras fracionadas.",
                    icon: Icons.Lightbulb
                },
                {
                    title: "Histórico de Preços",
                    text: "Consulte cotações antigas antes de fechar negócio. Identificar a variação de preço ao longo do tempo ajuda a negociar melhor.",
                    icon: Icons.TrendingUp
                },
                {
                    title: "Prazos de Entrega",
                    text: "Sempre registre o prazo de entrega nas observações. O menor preço nem sempre compensa se o material não chegar a tempo.",
                    icon: Icons.Clock
                },
                 {
                    title: "Agrupamento",
                    text: "Tente agrupar compras pequenas em uma única cotação maior. Fornecedores tendem a dar mais descontos para volumes maiores.",
                    icon: Icons.Package
                }
            ];

            const [currentTipIndex, setCurrentTipIndex] = useState(0);

            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentTipIndex((prev) => (prev + 1) % tips.length);
                }, 8000);
                return () => clearInterval(interval);
            }, []);

            const currentTip = tips[currentTipIndex];

            return (
                <div className="space-y-8 animate-fade-in no-print">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 mb-2">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-800 tracking-tight">Painel de Controle</h2>
                            <p className="text-slate-500 mt-1">Acompanhe o desempenho das suas compras.</p>
                        </div>
                        <button onClick={onNew} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-xl flex items-center shadow-lg shadow-blue-200 transition transform hover:-translate-y-0.5 active:translate-y-0">
                            <Icons.Plus className="h-5 w-5 mr-2" /> Criar Nova Cotação
                        </button>
                    </div>

                    {/* Grid de Stats Moderno */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-[0_2px_10px_-3px_rgba(6,81,237,0.1)] border border-slate-100 flex flex-col justify-between h-32 hover:border-blue-200 transition-all cursor-default relative overflow-hidden group">
                             <div className="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                             <div className="relative z-10">
                                <p className="text-sm font-bold text-slate-400 uppercase tracking-wide mb-1">Cotações Totais</p>
                                <h3 className="text-4xl font-bold text-slate-800">{stats.totalQuotes}</h3>
                            </div>
                            <div className="relative z-10 flex items-center text-blue-600 text-sm font-medium">
                                <Icons.FileText className="h-4 w-4 mr-1" /> Ver todas
                            </div>
                        </div>
                        
                        <div className="bg-white p-6 rounded-2xl shadow-[0_2px_10px_-3px_rgba(147,51,234,0.1)] border border-slate-100 flex flex-col justify-between h-32 hover:border-purple-200 transition-all cursor-default relative overflow-hidden group">
                             <div className="absolute top-0 right-0 w-24 h-24 bg-purple-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                             <div className="relative z-10">
                                <p className="text-sm font-bold text-slate-400 uppercase tracking-wide mb-1">Finalizadas</p>
                                <h3 className="text-4xl font-bold text-slate-800">{stats.completedQuotes}</h3>
                            </div>
                            <div className="relative z-10 flex items-center text-purple-600 text-sm font-medium">
                                <Icons.Check className="h-4 w-4 mr-1" /> Concluídas
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-2xl shadow-[0_2px_10px_-3px_rgba(234,88,12,0.1)] border border-slate-100 flex flex-col justify-between h-32 hover:border-orange-200 transition-all cursor-default relative overflow-hidden group">
                             <div className="absolute top-0 right-0 w-24 h-24 bg-orange-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                             <div className="relative z-10 overflow-hidden">
                                <p className="text-sm font-bold text-slate-400 uppercase tracking-wide mb-1">Top Fornecedor</p>
                                <h3 className="text-2xl font-bold text-slate-800 truncate leading-tight" title={stats.topWinner}>{stats.topWinner}</h3>
                            </div>
                            <div className="relative z-10 flex items-center text-orange-600 text-sm font-medium">
                                <Icons.Trophy className="h-4 w-4 mr-1" /> Liderando
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Lista de Atividade Recente (Bento Grid Style) */}
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 col-span-2">
                            <h3 className="font-bold text-slate-800 mb-6 flex items-center text-lg">
                                <Icons.Clock className="h-5 w-5 mr-2 text-slate-400" /> Atividades Recentes
                            </h3>
                            
                            <div className="grid gap-3">
                                {recentQuotes.map(q => (
                                    <div 
                                        key={q.id} 
                                        onClick={() => onOpen(q)}
                                        className="flex items-center justify-between p-4 bg-slate-50 hover:bg-white hover:shadow-md border border-transparent hover:border-slate-100 rounded-2xl cursor-pointer transition-all group"
                                    >
                                        <div className="flex items-center gap-4">
                                            <div className="bg-white p-3 rounded-xl border border-slate-100 text-slate-400 group-hover:text-blue-600 group-hover:border-blue-100 transition shadow-sm">
                                                <Icons.FileText className="h-5 w-5" />
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-slate-700 text-sm group-hover:text-blue-700 transition">{q.title || "Nova Cotação"}</h4>
                                                <span className="text-xs text-slate-400 flex items-center mt-0.5">
                                                    {new Date(q.date).toLocaleDateString('pt-BR')}
                                                </span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${q.status === 'Finalizada' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}`}>
                                                {q.status}
                                            </span>
                                            <div className="h-8 w-8 rounded-full bg-slate-200 group-hover:bg-blue-600 flex items-center justify-center transition">
                                                <Icons.ChevronRight className="h-4 w-4 text-slate-500 group-hover:text-white transition" />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {recentQuotes.length === 0 && (
                                    <div className="text-center py-12 text-slate-400 bg-slate-50/50 rounded-2xl border border-dashed border-slate-200">
                                        <p>Nenhuma cotação recente encontrada.</p>
                                        <button onClick={onNew} className="text-blue-600 text-sm font-bold mt-2 hover:underline">Criar a primeira</button>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Card Dica Pro - Rotativo */}
                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-8 rounded-3xl shadow-xl text-white relative overflow-hidden flex flex-col justify-between h-full min-h-[300px]">
                            <div>
                                <div className="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                                <div className="absolute bottom-0 left-0 w-40 h-40 bg-blue-500 opacity-20 rounded-full blur-3xl -ml-10 -mb-10 pointer-events-none"></div>
                                
                                <div className="bg-white/10 w-12 h-12 rounded-2xl flex items-center justify-center mb-6 backdrop-blur-md border border-white/10 transition-all">
                                    <currentTip.icon className="h-6 w-6 text-yellow-300" />
                                </div>
                                
                                <div className="animate-fade-in" key={currentTipIndex}>
                                    <h3 className="font-bold text-2xl mb-3 relative z-10">{currentTip.title}</h3>
                                    <p className="text-slate-300 text-sm leading-relaxed relative z-10">
                                        {currentTip.text}
                                    </p>
                                </div>
                            </div>
                            
                            <div className="relative z-10 mt-8">
                                <div className="flex justify-between text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">
                                    <span>Dica {currentTipIndex + 1} de {tips.length}</span>
                                    <div className="flex space-x-1">
                                        {tips.map((_, idx) => (
                                            <div key={idx} className={`h-1.5 w-1.5 rounded-full transition-colors ${idx === currentTipIndex ? 'bg-white' : 'bg-white/20'}`} />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function QuotationList({ quotations, onNew, onOpen, onDelete }) {
            const [quoteToDelete, setQuoteToDelete] = useState(null);

            return (
                <div className="space-y-6 animate-fade-in no-print">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800">Minhas Cotações</h2>
                        <button onClick={onNew} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl flex items-center shadow-sm transition font-medium"><Icons.Plus className="h-5 w-5 mr-2" /> Nova Cotação</button>
                    </div>
                    
                    {/* Lista em Grid de Cards Modernos */}
                    <div className="grid gap-4">
                        {quotations.map(q => (
                            <div 
                                key={q.id} 
                                onClick={() => onOpen(q)}
                                className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all duration-300 cursor-pointer group relative overflow-hidden"
                            >
                                <div className="flex justify-between items-start mb-4">
                                    <div className="flex items-center gap-4">
                                        <div className={`p-3 rounded-xl transition-colors ${q.status === 'Finalizada' ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-50 text-blue-600'}`}>
                                            {q.status === 'Finalizada' ? <Icons.Check className="h-6 w-6" /> : <Icons.FileText className="h-6 w-6" />}
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-slate-800 text-lg group-hover:text-blue-600 transition">{q.title || "Nova Cotação"}</h3>
                                            <p className="text-xs text-slate-400 font-medium flex items-center mt-1">
                                                <Icons.Clock className="h-3 w-3 mr-1" /> {new Date(q.date).toLocaleDateString('pt-BR')}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    {/* Botão de Excluir (Discreto) */}
                                    <button 
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setQuoteToDelete(q);
                                        }}
                                        className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition opacity-0 group-hover:opacity-100"
                                        title="Excluir"
                                    >
                                        <Icons.Trash2 className="h-5 w-5" />
                                    </button>
                                </div>

                                <div className="flex items-end justify-between border-t border-slate-50 pt-4">
                                    <div>
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Vencedor</p>
                                        <div className="flex items-center text-slate-700 font-medium text-sm">
                                            {q.winner && q.winner !== 'N/A' ? (
                                                <><Icons.Trophy className="h-4 w-4 text-yellow-500 mr-2" /> {q.winner}</>
                                            ) : (
                                                <span className="text-slate-400 italic">Em aberto</span>
                                            )}
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Total</p>
                                        <p className={`text-xl font-bold font-mono ${q.status === 'Finalizada' ? 'text-emerald-600' : 'text-slate-800'}`}>
                                            {q.total ? `R$ ${q.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : '-'}
                                        </p>
                                    </div>
                                </div>
                                
                                {/* Status Badge flutuante se necessário, ou integrado visualmente */}
                                <div className={`absolute top-0 right-0 w-1.5 h-full ${q.status === 'Finalizada' ? 'bg-emerald-500' : 'bg-blue-500'} opacity-0 group-hover:opacity-100 transition-opacity`}></div>
                            </div>
                        ))}
                        
                        {quotations.length === 0 && (
                            <div className="p-12 text-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200">
                                Nenhuma cotação encontrada. Comece criando uma nova!
                            </div>
                        )}
                    </div>

                    {/* Modal de Confirmação de Exclusão (Novo Layout) */}
                    {quoteToDelete && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 animate-fade-in" onClick={() => setQuoteToDelete(null)}>
                            {/* Overlay transparente para capturar cliques fora */}
                            <div className="absolute inset-0 bg-transparent" />
                            
                            <div className="bg-white rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.15)] border border-slate-100 max-w-xs w-full overflow-hidden transform transition-all scale-100 relative z-10 p-6" onClick={e => e.stopPropagation()}>
                                <div className="flex flex-col items-center text-center">
                                    <div className="h-12 w-12 bg-red-50 rounded-2xl flex items-center justify-center mb-4 text-red-500 shadow-sm">
                                        <Icons.Trash2 className="h-6 w-6" />
                                    </div>
                                    
                                    <h3 className="text-lg font-bold text-slate-800 mb-1">Apagar Cotação?</h3>
                                    
                                    <p className="text-sm text-slate-500 mb-6 leading-relaxed px-2">
                                        Isso excluirá permanentemente <br/>
                                        <span className="font-semibold text-slate-700">"{quoteToDelete.title}"</span>.
                                    </p>
                                    
                                    <div className="flex flex-col w-full gap-2">
                                        <button 
                                            onClick={() => {
                                                onDelete(quoteToDelete.id);
                                                setQuoteToDelete(null);
                                            }}
                                            className="w-full py-2.5 px-4 bg-red-600 text-white rounded-xl text-sm font-medium hover:bg-red-700 shadow-md shadow-red-100 transition active:scale-95"
                                        >
                                            Sim, excluir agora
                                        </button>
                                        <button 
                                            onClick={() => setQuoteToDelete(null)}
                                            className="w-full py-2.5 px-4 bg-white text-slate-500 rounded-xl text-sm font-medium hover:bg-slate-50 hover:text-slate-700 transition"
                                        >
                                            Cancelar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Editor Moderno com Cards e Resumos ---
        function QuotationEditor({ quote, setQuote, onBack, onPrint }) {
            const [newItemName, setNewItemName] = useState('');
            const [newItemQty, setNewItemQty] = useState(1);
            const [newItemUnit, setNewItemUnit] = useState('un');
            const [newSupplierName, setNewSupplierName] = useState('');
            const [editingItemId, setEditingItemId] = useState(null);
            const [tempItemName, setTempItemName] = useState('');
            
            // Novos estados para edição
            const [editingSupplierId, setEditingSupplierId] = useState(null);
            const [tempSupplierName, setTempSupplierName] = useState('');
            
            const [editingItemQtyId, setEditingItemQtyId] = useState(null);
            const [tempItemQty, setTempItemQty] = useState('');

            const addItem = () => {
                if (!newItemName) return;
                const item = { id: Date.now(), name: newItemName, qty: parseFloat(newItemQty), unit: newItemUnit };
                setQuote({ ...quote, items: [...quote.items, item] });
                setNewItemName(''); setNewItemQty(1);
            };

            const addSupplier = () => {
                if (!newSupplierName) return;
                const supplier = { id: Date.now(), name: newSupplierName };
                setQuote({ ...quote, suppliers: [...quote.suppliers, supplier] });
                setNewSupplierName('');
            };

            const updatePrice = (itemId, supplierId, value) => {
                const key = `${itemId}_${supplierId}`;
                setQuote({ ...quote, prices: { ...quote.prices, [key]: value } });
            };

            const updateQuantity = (itemId, supplierId, value) => {
                const key = `${itemId}_${supplierId}`;
                setQuote({ ...quote, quantities: { ...quote.quantities, [key]: value } });
            };

            const startEditingItem = (item) => {
                setEditingItemId(item.id);
                setTempItemName(item.name);
            };

            const saveItemName = (id) => {
                if (tempItemName.trim()) {
                    setQuote({ ...quote, items: quote.items.map(i => i.id === id ? { ...i, name: tempItemName } : i) });
                }
                setEditingItemId(null);
            };
            
            // Funções para editar nome do fornecedor
            const startEditingSupplier = (supplier) => {
                setEditingSupplierId(supplier.id);
                setTempSupplierName(supplier.name);
            };

            const saveSupplierName = (id) => {
                if (tempSupplierName.trim()) {
                    setQuote({ ...quote, suppliers: quote.suppliers.map(s => s.id === id ? { ...s, name: tempSupplierName } : s) });
                }
                setEditingSupplierId(null);
            };
            
            // Funções para editar quantidade base do item
            const startEditingItemQty = (item) => {
                setEditingItemQtyId(item.id);
                setTempItemQty(item.qty);
            };

            const saveItemQty = (id) => {
                const newQty = parseFloat(tempItemQty);
                if (!isNaN(newQty) && newQty > 0) {
                    setQuote({ ...quote, items: quote.items.map(i => i.id === id ? { ...i, qty: newQty } : i) });
                }
                setEditingItemQtyId(null);
            };

            const removeItem = (id) => setQuote({ ...quote, items: quote.items.filter(i => i.id !== id) });
            const removeSupplier = (id) => setQuote({ ...quote, suppliers: quote.suppliers.filter(s => s.id !== id) });

            const calculations = useMemo(() => {
                const totalsPerSupplier = {};
                let minTotal = Infinity;
                let winnerId = null;
                let bestMixTotal = 0;

                quote.suppliers.forEach(s => {
                    let sum = 0;
                    quote.items.forEach(i => {
                        const key = `${i.id}_${s.id}`;
                        const qty = quote.quantities?.[key] !== undefined ? parseFloat(quote.quantities[key]) : i.qty;
                        sum += (parseFloat(quote.prices[key]) || 0) * qty;
                    });
                    totalsPerSupplier[s.id] = sum;
                    if (sum > 0 && sum < minTotal) { minTotal = sum; winnerId = s.id; }
                });

                quote.items.forEach(i => {
                    let minItemPrice = Infinity;
                    let hasPrice = false;
                    quote.suppliers.forEach(s => {
                        const key = `${i.id}_${s.id}`;
                        const p = parseFloat(quote.prices[key]) || 0;
                        const qty = quote.quantities?.[key] !== undefined ? parseFloat(quote.quantities[key]) : i.qty;
                        
                        if (p > 0) {
                            const total = p * qty;
                            if (total < minItemPrice) minItemPrice = total;
                            hasPrice = true;
                        }
                    });
                    if (hasPrice) bestMixTotal += minItemPrice;
                });

                return { 
                    totalsPerSupplier, 
                    winnerId, 
                    minTotal: (minTotal === Infinity ? 0 : minTotal),
                    bestMixTotal
                };
            }, [quote]);

            const summaryStats = useMemo(() => {
                const itemCount = quote.items.length;
                const supplierCount = quote.suppliers.length;
                const bestPrice = calculations.winnerId ? calculations.totalsPerSupplier[calculations.winnerId] : 0;
                let highestPrice = 0;
                Object.values(calculations.totalsPerSupplier).forEach(val => { if (val > highestPrice) highestPrice = val; });
                const savings = highestPrice > 0 && bestPrice > 0 ? highestPrice - bestPrice : 0;
                const winnerName = quote.suppliers.find(s => s.id === calculations.winnerId)?.name || 'N/A';
                
                const mixSavings = bestPrice > 0 ? bestPrice - calculations.bestMixTotal : 0;

                return { itemCount, supplierCount, bestPrice, savings, winnerName, mixSavings };
            }, [quote, calculations]);

            // Handler para impressão em nova janela
            const handlePrint = () => {
                openPrintWindow(quote, calculations, summaryStats);
            };

            return (
                <div className="space-y-8 animate-fade-in no-print max-w-full">
                    {/* Header Moderno com Indicador de Auto-Save */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div className="flex items-center space-x-4 w-full md:w-auto">
                            <button onClick={onBack} className="p-3 bg-slate-50 hover:bg-slate-100 rounded-xl transition text-slate-600">
                                <Icons.ArrowLeft className="h-5 w-5" />
                            </button>
                            <div className="flex-1">
                                <div className="flex items-center gap-3">
                                    <label className="text-xs font-bold text-blue-600 uppercase tracking-wider">Editando Cotação</label>
                                    <span className="flex items-center text-[10px] text-green-600 bg-green-50 px-2 py-0.5 rounded-full font-medium">
                                        <Icons.CloudCheck className="h-3 w-3 mr-1" /> Salvo automaticamente
                                    </span>
                                </div>
                                <input 
                                    type="text" 
                                    value={quote.title} 
                                    onChange={(e) => setQuote({...quote, title: e.target.value})}
                                    className="text-2xl font-bold text-slate-800 bg-transparent border-none p-0 w-full focus:ring-0 placeholder-slate-300" 
                                    placeholder="Nome da Cotação..."
                                />
                                <div className="flex items-center text-sm text-slate-400 mt-1">
                                    <Icons.FileText className="h-3 w-3 mr-1" />
                                    {new Date(quote.date).toLocaleDateString('pt-BR')}
                                </div>
                            </div>
                        </div>
                        <div className="flex space-x-3 w-full md:w-auto">
                            <button onClick={handlePrint} className="flex-1 md:flex-none justify-center bg-slate-100 hover:bg-slate-200 text-slate-700 px-5 py-3 rounded-xl flex items-center transition font-medium">
                                <Icons.Printer className="h-5 w-5 mr-2" /> <span className="hidden sm:inline">Imprimir Relatório</span>
                            </button>
                            <button onClick={onBack} className="flex-1 md:flex-none justify-center bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl flex items-center shadow-lg shadow-blue-200 transition font-medium">
                                <Icons.Check className="h-5 w-5 mr-2" /> Concluir
                            </button>
                        </div>
                    </div>

                    {/* 2. Cards de Resumo */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center hover:shadow-md transition">
                            <div className="bg-blue-50 p-2.5 rounded-full text-blue-600 mb-3"><Icons.Package className="h-5 w-5" /></div>
                            <span className="text-2xl font-bold text-slate-800">{summaryStats.itemCount}</span>
                            <span className="text-xs text-slate-400 font-bold uppercase tracking-wider">Itens</span>
                        </div>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center hover:shadow-md transition">
                            <div className="bg-purple-50 p-2.5 rounded-full text-purple-600 mb-3"><Icons.Store className="h-5 w-5" /></div>
                            <span className="text-2xl font-bold text-slate-800">{summaryStats.supplierCount}</span>
                            <span className="text-xs text-slate-400 font-bold uppercase tracking-wider">Fornecedores</span>
                        </div>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center relative overflow-hidden hover:shadow-md transition">
                            <div className="bg-green-50 p-2.5 rounded-full text-green-600 mb-3"><Icons.Trophy className="h-5 w-5" /></div>
                            <span className="text-lg font-bold text-slate-800 truncate w-full px-2" title={summaryStats.winnerName}>{summaryStats.winnerName}</span>
                            <span className="text-xs text-slate-400 font-bold uppercase tracking-wider">Vencedor</span>
                            {summaryStats.bestPrice > 0 && <div className="text-xs text-green-600 font-bold mt-1 bg-green-50 px-2 py-0.5 rounded-full">R$ {summaryStats.bestPrice.toLocaleString('pt-BR')}</div>}
                        </div>
                        <div className="bg-gradient-to-br from-indigo-500 to-purple-600 p-5 rounded-2xl shadow-md text-white flex flex-col items-center justify-center text-center relative overflow-hidden">
                             {/* Card Inteligente de Economia */}
                             {summaryStats.mixSavings > 0 ? (
                                <>
                                    <div className="absolute top-2 right-2 animate-pulse"><Icons.Lightbulb className="h-5 w-5 text-yellow-300" /></div>
                                    <span className="text-2xl font-bold">R$ {(summaryStats.savings + summaryStats.mixSavings).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                                    <span className="text-xs text-indigo-100 font-bold uppercase tracking-wider mt-1">Economia Máxima</span>
                                    <div className="text-[10px] bg-white/20 px-2 py-0.5 rounded mt-2">Com compra fracionada</div>
                                </>
                             ) : (
                                <>
                                    <div className="bg-white/20 p-2 rounded-full mb-3 backdrop-blur-sm"><Icons.TrendingUp className="h-5 w-5 text-white" /></div>
                                    <span className="text-2xl font-bold">R$ {summaryStats.savings.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                                    <span className="text-xs text-indigo-100 font-bold uppercase tracking-wider">Economia Total</span>
                                    <span className="text-[10px] text-indigo-200 mt-1">vs. Maior Proposta</span>
                                </>
                             )}
                        </div>
                    </div>
                    
                    {/* Alerta de Sugestão de Mix se valer a pena */}
                    {summaryStats.mixSavings > 0 && (
                        <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start gap-3 text-amber-800 animate-fade-in mt-6">
                            <div className="bg-amber-100 p-2 rounded-lg"><Icons.Split className="h-6 w-6 text-amber-600" /></div>
                            <div>
                                <h4 className="font-bold text-sm uppercase mb-1">Oportunidade de Economia Detectada!</h4>
                                <p className="text-sm">
                                    Se você comprar cada item separadamente no fornecedor mais barato, o total será <strong>R$ {calculations.bestMixTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>. 
                                    Isso gera uma economia adicional de <strong>R$ {summaryStats.mixSavings.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong> em relação ao vencedor.
                                </p>
                            </div>
                        </div>
                    )}

                    {/* 3. Área de Entrada (Cards Estilizados) */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative group">
                            <div className="absolute top-4 bottom-4 left-0 w-1.5 bg-blue-500 rounded-r-full"></div>
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center text-lg pl-3">
                                <span className="bg-blue-50 text-blue-600 p-1.5 rounded-lg mr-3"><Icons.Package className="h-5 w-5" /></span>
                                Adicionar Item
                            </h3>
                            <div className="flex gap-3">
                                <div className="flex-1 relative">
                                    <input type="text" placeholder="Nome do item..." className="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 transition placeholder-slate-400" value={newItemName} onChange={e => setNewItemName(e.target.value)} onKeyDown={e => e.key === 'Enter' && addItem()} />
                                </div>
                                <div className="flex gap-2">
                                    <input type="number" placeholder="Qtd" className="w-20 bg-slate-50 border-none rounded-xl px-3 py-3 text-sm focus:ring-2 focus:ring-blue-500 text-center" value={newItemQty} onChange={e => setNewItemQty(e.target.value)} />
                                    <select className="w-20 bg-slate-50 border-none rounded-xl px-2 py-3 text-sm focus:ring-2 focus:ring-blue-500 text-center cursor-pointer text-slate-600" value={newItemUnit} onChange={e => setNewItemUnit(e.target.value)}><option>un</option><option>kg</option><option>m</option><option>m²</option><option>cx</option></select>
                                </div>
                            </div>
                            <button onClick={addItem} className="w-full mt-3 bg-blue-50 hover:bg-blue-100 text-blue-600 py-2.5 rounded-xl font-medium text-sm transition flex items-center justify-center">
                                <Icons.Plus className="h-4 w-4 mr-1" /> Inserir Item
                            </button>
                        </div>

                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative group">
                            <div className="absolute top-4 bottom-4 left-0 w-1.5 bg-purple-500 rounded-r-full"></div>
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center text-lg pl-3">
                                <span className="bg-purple-50 text-purple-600 p-1.5 rounded-lg mr-3"><Icons.Store className="h-5 w-5" /></span>
                                Adicionar Concorrente
                            </h3>
                            <div className="flex gap-3">
                                <input type="text" placeholder="Nome da Loja / Fornecedor..." className="flex-1 bg-slate-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-purple-500 transition placeholder-slate-400" value={newSupplierName} onChange={e => setNewSupplierName(e.target.value)} onKeyDown={e => e.key === 'Enter' && addSupplier()} />
                            </div>
                            <button onClick={addSupplier} className="w-full mt-3 bg-purple-50 hover:bg-purple-100 text-purple-600 py-2.5 rounded-xl font-medium text-sm transition flex items-center justify-center">
                                <Icons.Plus className="h-4 w-4 mr-1" /> Inserir Fornecedor
                            </button>
                        </div>
                    </div>

                    {/* 4. O Mapa (Card Principal) */}
                    <div className="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden mt-6">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <div>
                                <h3 className="font-bold text-slate-800 text-lg">Comparativo de Preços</h3>
                                <p className="text-slate-400 text-xs mt-1">Preencha os valores unitários nas colunas abaixo</p>
                            </div>
                            <div className="hidden sm:flex items-center gap-4 text-xs font-medium text-slate-500">
                                <div className="flex items-center"><span className="w-3 h-3 bg-green-200 border border-green-300 rounded-full mr-2 shadow-sm"></span> Melhor Preço do Item</div>
                                <div className="flex items-center"><span className="w-3 h-3 bg-emerald-600 rounded-full mr-2 shadow-sm"></span> Fornecedor Vencedor (Total)</div>
                            </div>
                        </div>

                        <div className="overflow-x-auto custom-scrollbar pb-2">
                            <table className="w-full border-collapse min-w-[800px]">
                                <thead>
                                    <tr className="bg-slate-50/80 text-slate-500 text-xs font-bold uppercase tracking-wider">
                                        <th className="py-4 px-4 border-r border-slate-100 w-12 text-center">#</th>
                                        <th className="py-4 px-4 text-left border-r border-slate-100 min-w-[200px]">Item</th>
                                        <th className="py-4 px-4 text-center border-r border-slate-100 w-24">Qtd.</th>
                                        {quote.suppliers.map(s => (
                                            <th key={s.id} className={`py-4 px-4 text-center border-r border-slate-100 min-w-[140px] relative group ${calculations.winnerId === s.id ? 'bg-emerald-50 text-emerald-800' : ''}`}>
                                                {editingSupplierId === s.id ? (
                                                    <input 
                                                        autoFocus
                                                        className="w-full bg-white border border-blue-400 rounded px-2 py-1 text-center text-xs font-bold text-slate-700 outline-none"
                                                        value={tempSupplierName}
                                                        onChange={(e) => setTempSupplierName(e.target.value)}
                                                        onBlur={() => saveSupplierName(s.id)}
                                                        onKeyDown={(e) => e.key === 'Enter' && saveSupplierName(s.id)}
                                                    />
                                                ) : (
                                                    <span 
                                                        className="cursor-pointer hover:text-blue-600 transition"
                                                        onClick={() => startEditingSupplier(s)}
                                                        title="Clique para editar nome"
                                                    >
                                                        {s.name}
                                                    </span>
                                                )}
                                                <button onClick={() => removeSupplier(s.id)} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition"><Icons.Trash2 className="h-3 w-3" /></button>
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className="text-slate-600 text-sm">
                                    {quote.items.map(item => {
                                        const rowPrices = quote.suppliers
                                            .map(s => parseFloat(quote.prices[`${item.id}_${s.id}`]) || 0)
                                            .filter(p => p > 0);
                                        const minRowPrice = rowPrices.length > 0 ? Math.min(...rowPrices) : null;

                                        return (
                                            <tr key={item.id} className="border-b border-slate-50 hover:bg-blue-50/30 transition">
                                                <td className="p-3 text-center border-r border-slate-50">
                                                    <button onClick={() => removeItem(item.id)} className="text-slate-300 hover:text-red-500 transition p-1 hover:bg-red-50 rounded"><Icons.Trash2 className="h-4 w-4" /></button>
                                                </td>
                                                <td className="p-3 border-r border-slate-50 font-medium text-slate-800 group relative">
                                                    {editingItemId === item.id ? (
                                                        <input 
                                                            autoFocus
                                                            className="w-full border-blue-400 border rounded px-2 py-1 outline-none shadow-sm"
                                                            value={tempItemName}
                                                            onChange={e => setTempItemName(e.target.value)}
                                                            onBlur={() => saveItemName(item.id)}
                                                            onKeyDown={e => e.key === 'Enter' && saveItemName(item.id)}
                                                        />
                                                    ) : (
                                                        <div className="flex items-center justify-between cursor-pointer" onClick={() => startEditingItem(item)}>
                                                            <span>{item.name}</span>
                                                            <Icons.Pencil className="h-3 w-3 text-slate-300 opacity-0 group-hover:opacity-100 ml-2" />
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="p-3 text-center border-r border-slate-50">
                                                    {editingItemQtyId === item.id ? (
                                                        <input 
                                                            autoFocus
                                                            type="number"
                                                            className="w-16 bg-white border border-blue-400 rounded px-1 py-0.5 text-center text-xs font-bold outline-none"
                                                            value={tempItemQty}
                                                            onChange={(e) => setTempItemQty(e.target.value)}
                                                            onBlur={() => saveItemQty(item.id)}
                                                            onKeyDown={(e) => e.key === 'Enter' && saveItemQty(item.id)}
                                                        />
                                                    ) : (
                                                        <span 
                                                            className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold cursor-pointer hover:bg-slate-200 transition"
                                                            onClick={() => startEditingItemQty(item)}
                                                            title="Clique para editar quantidade base"
                                                        >
                                                            {item.qty} {item.unit}
                                                        </span>
                                                    )}
                                                </td>
                                                {quote.suppliers.map(s => {
                                                    const priceVal = parseFloat(quote.prices[`${item.id}_${s.id}`]) || 0;
                                                    const isBestPrice = minRowPrice !== null && priceVal === minRowPrice;
                                                    const specificQty = quote.quantities[`${item.id}_${s.id}`];
                                                    const displayQty = specificQty !== undefined ? specificQty : item.qty;

                                                    return (
                                                        <td key={s.id} className={`p-2 border-r border-slate-50 ${isBestPrice ? 'bg-green-100/60 font-medium' : ''}`}>
                                                            <div className="relative group/input">
                                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">R$</span>
                                                                <input 
                                                                    type="number" 
                                                                    className={`w-full text-right bg-transparent outline-none border border-transparent hover:border-slate-200 focus:border-blue-400 focus:bg-white rounded px-2 py-1.5 pl-8 transition font-medium ${isBestPrice ? 'text-green-700 font-bold' : 'text-slate-700'}`}
                                                                    placeholder="0,00"
                                                                    value={quote.prices[`${item.id}_${s.id}`] || ''} 
                                                                    onChange={(e) => updatePrice(item.id, s.id, e.target.value)} 
                                                                />
                                                            </div>
                                                            <div className="flex items-center justify-end gap-1 mt-1 px-1">
                                                                <span className="text-[10px] text-slate-400">Qtd:</span>
                                                                <input 
                                                                    type="number" 
                                                                    className="w-12 text-right bg-transparent border-b border-slate-200 text-[10px] text-slate-500 focus:border-blue-400 outline-none"
                                                                    placeholder={item.qty}
                                                                    value={specificQty || ''}
                                                                    onChange={(e) => updateQuantity(item.id, s.id, e.target.value)}
                                                                />
                                                            </div>
                                                            {quote.prices[`${item.id}_${s.id}`] && (
                                                                <div className="text-[10px] text-right text-slate-400 mt-1 font-mono px-2 border-t border-dashed border-slate-200 pt-1">
                                                                    Total: {(parseFloat(quote.prices[`${item.id}_${s.id}`]) * parseFloat(displayQty)).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                                                </div>
                                                            )}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        );
                                    })}
                                    {quote.items.length === 0 && (
                                        <tr><td colSpan={3 + quote.suppliers.length} className="py-12 text-center text-slate-400 italic bg-slate-50/30">Adicione itens para começar o mapa comparativo.</td></tr>
                                    )}
                                </tbody>
                                {quote.items.length > 0 && quote.suppliers.length > 0 && (
                                    <tfoot className="bg-slate-50 border-t border-slate-200 font-bold text-slate-700">
                                        <tr>
                                            <td colSpan="3" className="py-5 px-4 text-right border-r border-slate-200 uppercase text-xs tracking-wider">Valor Total da Cotação:</td>
                                            {quote.suppliers.map(s => (
                                                <td key={s.id} className={`py-5 px-4 text-right border-r border-slate-200 text-sm ${calculations.winnerId === s.id ? 'bg-emerald-600 text-white shadow-inner' : ''}`}>
                                                    {calculations.winnerId === s.id && (
                                                        <div className="text-[10px] uppercase text-emerald-200 mb-1 flex items-center justify-end gap-1">
                                                            <Icons.Trophy className="h-3 w-3" /> Vencedor
                                                        </div>
                                                    )}
                                                    R$ {calculations.totalsPerSupplier[s.id].toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                                </td>
                                            ))}
                                        </tr>
                                    </tfoot>
                                )}
                            </table>
                        </div>
                    </div>
                    
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mt-6">
                        <label className="block text-sm font-bold text-slate-700 mb-2">Observações / Data de Faturamento</label>
                        <textarea
                            className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition resize-none h-24"
                            placeholder="Ex: Faturamento para 30 dias, Entrega imediata..."
                            value={quote.observation || ''}
                            onChange={(e) => setQuote({ ...quote, observation: e.target.value })}
                        />
                    </div>
                </div>
            );
        }

        // --- Aba de Configurações ---
        function Settings({ quotations, setQuotations }) {
            
            const handleBackup = () => {
                const dataStr = JSON.stringify(quotations, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_cotacoes_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleRestore = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json)) {
                            if(confirm('Atenção: A restauração substituirá TODAS as cotações atuais. Esta ação é irreversível. Deseja continuar?')) {
                                setQuotations(json);
                                alert('Backup restaurado com sucesso!');
                            }
                        } else {
                            alert('Arquivo inválido: O formato deve ser uma lista de cotações.');
                        }
                    } catch (error) {
                        alert('Erro ao ler o arquivo JSON. Certifique-se de que é um arquivo válido.');
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="max-w-4xl mx-auto space-y-8 animate-fade-in no-print">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-slate-800">Configurações</h2>
                        <p className="text-slate-500 mt-1">Gerencie seus dados e preferências do sistema.</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Card de Backup */}
                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-start relative overflow-hidden group">
                            <div className="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition"><Icons.Download className="h-32 w-32 text-blue-600" /></div>
                            
                            <div className="bg-blue-50 p-3 rounded-xl text-blue-600 mb-5">
                                <Icons.Download className="h-6 w-6" />
                            </div>
                            <h3 className="text-xl font-bold text-slate-800 mb-2">Fazer Backup</h3>
                            <p className="text-slate-500 text-sm mb-6 leading-relaxed">
                                Exporte todas as suas cotações e dados para um arquivo JSON seguro. Recomendamos fazer isso regularmente para evitar perda de dados.
                            </p>
                            <button 
                                onClick={handleBackup}
                                className="mt-auto w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-xl font-medium transition shadow-lg shadow-blue-100 flex items-center justify-center"
                            >
                                <Icons.Download className="h-5 w-5 mr-2" /> Baixar Dados
                            </button>
                        </div>

                        {/* Card de Recuperação */}
                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-start relative overflow-hidden group">
                             <div className="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition"><Icons.Upload className="h-32 w-32 text-orange-600" /></div>

                            <div className="bg-orange-50 p-3 rounded-xl text-orange-600 mb-5">
                                <Icons.Upload className="h-6 w-6" />
                            </div>
                            <h3 className="text-xl font-bold text-slate-800 mb-2">Restaurar Dados</h3>
                            <p className="text-slate-500 text-sm mb-4 leading-relaxed">
                                Importe um arquivo de backup (.json) para restaurar suas cotações. 
                            </p>
                            
                            <div className="w-full bg-orange-50 border border-orange-100 rounded-lg p-3 flex gap-3 mb-6">
                                <div className="shrink-0 pt-0.5"><Icons.AlertTriangle className="h-5 w-5 text-orange-500" /></div>
                                <div className="text-xs text-orange-800 font-medium">
                                    Cuidado: Restaurar um backup irá <strong>substituir</strong> todos os dados atuais existentes no sistema.
                                </div>
                            </div>

                            <div className="mt-auto w-full">
                                <label className="w-full bg-white border-2 border-dashed border-slate-300 hover:border-orange-400 hover:bg-orange-50 text-slate-500 hover:text-orange-600 py-3 px-4 rounded-xl font-medium transition cursor-pointer flex items-center justify-center">
                                    <Icons.Upload className="h-5 w-5 mr-2" /> Selecionar Arquivo
                                    <input 
                                        type="file" 
                                        accept=".json" 
                                        onChange={handleRestore} 
                                        className="hidden" 
                                    />
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-slate-100 rounded-xl p-6 text-center text-slate-500 text-sm">
                        <p>O sistema utiliza o armazenamento local do seu navegador (LocalStorage). Limpar o cache do navegador pode apagar seus dados se não houver backup.</p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
